---
version: '0'

rules:
  - name: Every source must have a snapshot
    subject:
      type: source
      relates-to:
        children: immediate  # /any
    must:
      have-relationship:
        cardinality: one_to_one
        related-type: snapshot

  - name: Snapshot must be prefixed with snap_
    subject:
      type: snapshot
    must:
      match-name: /snap_.*/

  - name: Non-base staging models must be prefixed with stg_
    subject:
      type: node  # node is the default type
      tags:
        - include: staging
          exclude: base
    must:
      match-name: 'stg_.*'

  - name: Base models must be prefixed with base_
    subject:
      tags: base  # want to be flexible about include/exclude/array/etc
    must:
      match-name: /base_.*/

  - name: 'All models must be tagged either: snapshot, base, staging, intermediate, core, mart'
    # Omit subject to include all nodes
    must:
      have-tags-any:
        - snaphost
        - base
        - staging
        - intermediate
        - core
        - mart

  - name: Snapshots must have 0 or 1 children, which must all be base models
    subject:
      type: snapshot
      relates-to:
        children: immediate
    must:
      have-relationship:
        cardinality: one_to_one
        required: false
        related-tags:
          - base

  - name: Intermediate models may only depend on non-base staging, core, mart, or other intermediate models
    subject:
      tags:
        include: intermediate
      relates-to:
        parents: immediate
    must:
      have-tags-any:
        - include: staging
          exclude: base
        - core
        - mart
        - intermediate

  - name: Core models must be tagged as dim or fct
    subject:
      tags: core
    must:
      have-tags-any:
        - dim
        - fct

  - name: Core dimension models must only depend on staging or intermediate
    subject:
      tags:
        include: dim
      relates-to:
        parents: immediate
    must:
      have-tags-any:
        - staging
        - intermediate

  - name: Core fact models must only depend on staging, intermediate, or dimension models
    subject:
      tags:
        include: fct
      relates-to:
        parents: immediate
    must:
      have-tags-any:
        - staging
        - intermediate
        - dim
